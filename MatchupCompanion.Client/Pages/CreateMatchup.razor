@page "/create-matchup"
@using MatchupCompanion.Shared.Models
@using MatchupCompanion.Client.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject IMatchupService MatchupService
@inject IChampionService ChampionService
@inject IRoleService RoleService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Crear Matchup</PageTitle>

<div class="container mt-4">
    <h1>Crear Nuevo Matchup</h1>
    <p class="lead">Comparte tu conocimiento sobre un matchup específico</p>

    <div class="row mt-4">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    @if (isLoadingData)
                    {
                        <div class="text-center my-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando datos...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@createMatchupDto" OnValidSubmit="@HandleSubmit">
                            <DataAnnotationsValidator />

                            @* Campo de búsqueda para Tu Campeón *@
                            <div class="mb-3">
                                <label for="playerChampion" class="form-label">Tu Campeón *</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control"
                                           @bind="playerChampionSearch"
                                           @bind:event="oninput"
                                           @onfocus="() => showPlayerDropdown = true"
                                           placeholder="Escribe para buscar tu campeón..." />
                                    @if (showPlayerDropdown && filteredPlayerChampions.Any())
                                    {
                                        <div class="dropdown-menu show w-100 autocomplete-dropdown">
                                            @foreach (var champion in filteredPlayerChampions.Take(10))
                                            {
                                                <button type="button" class="dropdown-item"
                                                        @onclick="() => SelectPlayerChampion(champion)">
                                                    @champion.Name
                                                </button>
                                            }
                                        </div>
                                    }
                                    @if (createMatchupDto.PlayerChampionId > 0)
                                    {
                                        <small class="text-success">Seleccionado: @GetChampionName(createMatchupDto.PlayerChampionId)</small>
                                    }
                                </div>
                                <ValidationMessage For="@(() => createMatchupDto.PlayerChampionId)" />
                            </div>

                            @* Campo de búsqueda para Campeón Enemigo *@
                            <div class="mb-3">
                                <label for="enemyChampion" class="form-label">Campeón Enemigo *</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control"
                                           @bind="enemyChampionSearch"
                                           @bind:event="oninput"
                                           @onfocus="() => showEnemyDropdown = true"
                                           placeholder="Escribe para buscar el campeón enemigo..." />
                                    @if (showEnemyDropdown && filteredEnemyChampions.Any())
                                    {
                                        <div class="dropdown-menu show w-100 autocomplete-dropdown">
                                            @foreach (var champion in filteredEnemyChampions.Take(10))
                                            {
                                                <button type="button" class="dropdown-item"
                                                        @onclick="() => SelectEnemyChampion(champion)">
                                                    @champion.Name
                                                </button>
                                            }
                                        </div>
                                    }
                                    @if (createMatchupDto.EnemyChampionId > 0)
                                    {
                                        <small class="text-success">Seleccionado: @GetChampionName(createMatchupDto.EnemyChampionId)</small>
                                    }
                                </div>
                                <ValidationMessage For="@(() => createMatchupDto.EnemyChampionId)" />
                            </div>

                            <div class="mb-3">
                                <label for="role" class="form-label">Rol *</label>
                                <select class="form-select" @bind="createMatchupDto.RoleId">
                                    <option value="0">-- Selecciona el rol --</option>
                                    @foreach (var role in roles)
                                    {
                                        <option value="@role.Id">@role.Name</option>
                                    }
                                </select>
                                <ValidationMessage For="@(() => createMatchupDto.RoleId)" />
                            </div>

                            <div class="mb-3">
                                <label for="difficulty" class="form-label">Dificultad *</label>
                                <div class="btn-group w-100" role="group">
                                    @foreach (var diff in difficulties)
                                    {
                                        <input type="radio" class="btn-check" name="difficulty" id="diff-@diff"
                                               value="@diff" checked="@(createMatchupDto.Difficulty == diff)"
                                               @onchange="@(() => createMatchupDto.Difficulty = diff)">
                                        <label class="btn @GetDifficultyButtonClass(diff)" for="diff-@diff">@diff</label>
                                    }
                                </div>
                                <ValidationMessage For="@(() => createMatchupDto.Difficulty)" />
                            </div>

                            <div class="mb-3">
                                <label for="generalAdvice" class="form-label">Consejo General</label>
                                <InputTextArea id="generalAdvice" class="form-control" rows="4"
                                               @bind-Value="createMatchupDto.GeneralAdvice"
                                               placeholder="Escribe un consejo general sobre cómo jugar este matchup..." />
                                <ValidationMessage For="@(() => createMatchupDto.GeneralAdvice)" />
                                <small class="form-text text-muted">@((createMatchupDto.GeneralAdvice?.Length ?? 0))/1000 caracteres</small>
                            </div>

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger" role="alert">
                                    @errorMessage
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(successMessage))
                            {
                                <div class="alert alert-success" role="alert">
                                    @successMessage
                                </div>
                            }

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Creando...</span>
                                    }
                                    else
                                    {
                                        <span>Crear Matchup</span>
                                    }
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    Cancelar
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .autocomplete-dropdown {
        position: absolute;
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .autocomplete-dropdown .dropdown-item:hover {
        background-color: #e9ecef;
    }
</style>

@code {
    private CreateMatchupDto createMatchupDto = new();
    private List<ChampionDto> champions = new();
    private List<RoleDto> roles = new();

    // Campos de búsqueda
    private string playerChampionSearch = "";
    private string enemyChampionSearch = "";

    // Control de dropdowns
    private bool showPlayerDropdown = false;
    private bool showEnemyDropdown = false;

    private bool isLoadingData = true;
    private bool isSubmitting = false;
    private string? errorMessage;
    private string? successMessage;

    private readonly string[] difficulties = { "Easy", "Medium", "Hard", "Extreme" };

    // Propiedades computadas para filtrar campeones
    private IEnumerable<ChampionDto> filteredPlayerChampions =>
        string.IsNullOrWhiteSpace(playerChampionSearch)
            ? Enumerable.Empty<ChampionDto>()
            : champions.Where(c => c.Name.Contains(playerChampionSearch, StringComparison.OrdinalIgnoreCase))
                       .OrderBy(c => c.Name);

    private IEnumerable<ChampionDto> filteredEnemyChampions =>
        string.IsNullOrWhiteSpace(enemyChampionSearch)
            ? Enumerable.Empty<ChampionDto>()
            : champions.Where(c => c.Name.Contains(enemyChampionSearch, StringComparison.OrdinalIgnoreCase))
                       .OrderBy(c => c.Name);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoadingData = true;
        try
        {
            champions = await ChampionService.GetAllChampionsAsync();
            roles = await RoleService.GetAllRolesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            isLoadingData = false;
        }
    }

    private void SelectPlayerChampion(ChampionDto champion)
    {
        createMatchupDto.PlayerChampionId = champion.Id;
        playerChampionSearch = champion.Name;
        showPlayerDropdown = false;
    }

    private void SelectEnemyChampion(ChampionDto champion)
    {
        createMatchupDto.EnemyChampionId = champion.Id;
        enemyChampionSearch = champion.Name;
        showEnemyDropdown = false;
    }

    private string GetChampionName(int championId)
    {
        return champions.FirstOrDefault(c => c.Id == championId)?.Name ?? "???";
    }

    private string GetDifficultyButtonClass(string difficulty) => difficulty switch
    {
        "Easy" => "btn-outline-success",
        "Medium" => "btn-outline-warning",
        "Hard" => "btn-outline-danger",
        "Extreme" => "btn-outline-dark",
        _ => "btn-outline-secondary"
    };

    private async Task HandleSubmit()
    {
        errorMessage = null;
        successMessage = null;

        if (createMatchupDto.PlayerChampionId == 0)
        {
            errorMessage = "Debes seleccionar tu campeón";
            return;
        }

        if (createMatchupDto.EnemyChampionId == 0)
        {
            errorMessage = "Debes seleccionar el campeón enemigo";
            return;
        }

        if (createMatchupDto.PlayerChampionId == createMatchupDto.EnemyChampionId)
        {
            errorMessage = "Los campeones no pueden ser iguales";
            return;
        }

        if (string.IsNullOrEmpty(createMatchupDto.Difficulty))
        {
            errorMessage = "Debes seleccionar una dificultad";
            return;
        }

        isSubmitting = true;

        try
        {
            var result = await MatchupService.CreateMatchupAsync(createMatchupDto);

            if (result != null)
            {
                successMessage = "Matchup creado exitosamente. Redirigiendo...";
                await Task.Delay(1500);
                Navigation.NavigateTo($"/matchup/{result.Id}");
            }
            else
            {
                errorMessage = "No se pudo crear el matchup";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al crear matchup: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/matchups");
    }
}
