@page "/matchup/{id:int}"
@using MatchupCompanion.Shared.Models
@using MatchupCompanion.Client.Services
@using MatchupCompanion.Client.Services.Auth
@using MatchupCompanion.Client.Components
@inject IMatchupService MatchupService
@inject IRuneService RuneService
@inject IItemService ItemService
@inject ISummonerSpellService SummonerSpellService
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<PageTitle>Detalles del Matchup</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando matchup...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> @errorMessage
        </div>
        <button class="btn btn-secondary" @onclick="GoBack">Volver</button>
    }
    else if (matchup == null)
    {
        <div class="alert alert-warning" role="alert">
            Matchup no encontrado
        </div>
        <button class="btn btn-secondary" @onclick="GoBack">Volver</button>
    }
    else
    {
        <div class="row">
            <div class="col-lg-12 d-flex justify-content-between">
                <button class="btn btn-secondary mb-3" @onclick="GoBack">
                    <i class="bi bi-arrow-left"></i> Volver
                </button>
                <div class="d-flex gap-2">
                    @if (canEdit)
                    {
                        <button class="btn btn-primary mb-3" @onclick="NavigateToEdit">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                    }
                    @if (canDelete)
                    {
                        <button class="btn btn-danger mb-3" @onclick="ShowDeleteConfirmation" disabled="@isDeleting">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    }
                </div>
            </div>
        </div>

        @if (showDeleteModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Confirmar Eliminación</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseDeleteConfirmation"></button>
                        </div>
                        <div class="modal-body">
                            <p>¿Estás seguro de que deseas eliminar este matchup?</p>
                            <p class="text-danger fw-bold">Esta acción no se puede deshacer.</p>
                            <p><strong>Matchup:</strong> @matchup?.PlayerChampion.Name VS @matchup?.EnemyChampion.Name</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseDeleteConfirmation">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                                @if (isDeleting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                }
                                Sí, eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            @matchup?.PlayerChampion.Name VS @matchup?.EnemyChampion.Name
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Tu Campeón: @matchup.PlayerChampion.Name</h5>
                                @if (!string.IsNullOrEmpty(matchup.PlayerChampion.Title))
                                {
                                    <p class="text-muted">@matchup.PlayerChampion.Title</p>
                                }
                            </div>
                            <div class="col-md-6">
                                <h5>Campeón Enemigo: @matchup.EnemyChampion.Name</h5>
                                @if (!string.IsNullOrEmpty(matchup.EnemyChampion.Title))
                                {
                                    <p class="text-muted">@matchup.EnemyChampion.Title</p>
                                }
                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Rol:</strong>
                                <span class="badge bg-secondary ms-2">@matchup.Role.Name</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Dificultad:</strong>
                                <span class="badge @GetDifficultyBadgeClass(matchup.Difficulty) ms-2">
                                    @matchup.Difficulty
                                </span>
                            </div>
                            <div class="col-md-4">
                                <strong>Tips:</strong>
                                <span class="badge bg-info ms-2">@matchup.Tips.Count</span>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(matchup.GeneralAdvice))
                        {
                            <hr />
                            <div class="alert alert-info" role="alert">
                                <strong>Consejo General:</strong>
                                <p class="mb-0 mt-2">@matchup.GeneralAdvice</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Sección de Runas *@
        @if (matchup.KeystoneId.HasValue || matchup.SecondaryTreeId.HasValue)
        {
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0">Runas Recomendadas</h4>
                        </div>
                        <div class="card-body p-0">
                            <RuneTreeDisplay
                                PrimaryTree="@primaryTree"
                                SecondaryTree="@secondaryTree"
                                SelectedKeystoneId="@matchup.KeystoneId"
                                SelectedPrimaryRune1Id="@matchup.PrimaryRune1Id"
                                SelectedPrimaryRune2Id="@matchup.PrimaryRune2Id"
                                SelectedPrimaryRune3Id="@matchup.PrimaryRune3Id"
                                SelectedSecondaryRune1Id="@matchup.SecondaryRune1Id"
                                SelectedSecondaryRune2Id="@matchup.SecondaryRune2Id"
                                StatShards="@matchup.StatShards"
                                SelectedKeystone="@keystoneRune"
                                SelectedPrimaryRune1="@primaryRune1"
                                SelectedPrimaryRune2="@primaryRune2"
                                SelectedPrimaryRune3="@primaryRune3"
                                SelectedSecondaryRune1="@secondaryRune1"
                                SelectedSecondaryRune2="@secondaryRune2" />
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Sección de Items *@
        @if (!string.IsNullOrEmpty(matchup.StartingItems) || !string.IsNullOrEmpty(matchup.CoreItems) || !string.IsNullOrEmpty(matchup.SituationalItems) || !string.IsNullOrEmpty(matchup.FullBuildItems))
        {
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h4 class="mb-0">Items Recomendados</h4>
                        </div>
                        <div class="card-body">
                            @if (startingItems.Any())
                            {
                                <div class="mb-3">
                                    <h5>Items Iniciales</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var item in startingItems)
                                        {
                                            <div class="text-center" title="@item.Name - @item.TotalGold g">
                                                @if (!string.IsNullOrEmpty(item.IconUrl))
                                                {
                                                    <img src="@item.IconUrl" alt="@item.Name"
                                                         style="width: 40px; height: 40px; border-radius: 4px; border: 2px solid #6c757d;" />
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary p-2">
                                                        @item.Name
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            @if (coreItems.Any())
                            {
                                <div class="mb-3">
                                    <h5>Items Core</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var item in coreItems)
                                        {
                                            <div class="text-center" title="@item.Name - @item.TotalGold g">
                                                @if (!string.IsNullOrEmpty(item.IconUrl))
                                                {
                                                    <img src="@item.IconUrl" alt="@item.Name"
                                                         style="width: 48px; height: 48px; border-radius: 4px; border: 2px solid #0d6efd;" />
                                                }
                                                else
                                                {
                                                    <span class="badge bg-primary p-2">
                                                        @item.Name
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            @if (situationalItems.Any())
                            {
                                <div class="mb-3">
                                    <h5>Items Situacionales</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var item in situationalItems)
                                        {
                                            <div class="text-center" title="@item.Name - @item.TotalGold g">
                                                @if (!string.IsNullOrEmpty(item.IconUrl))
                                                {
                                                    <img src="@item.IconUrl" alt="@item.Name"
                                                         style="width: 48px; height: 48px; border-radius: 4px; border: 2px solid #0dcaf0;" />
                                                }
                                                else
                                                {
                                                    <span class="badge bg-info p-2">
                                                        @item.Name
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            @if (fullBuildItems.Any())
                            {
                                <div class="mb-3">
                                    <h5>Full Build (6 Items)</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var item in fullBuildItems)
                                        {
                                            <div class="text-center" title="@item.Name - @item.TotalGold g">
                                                @if (!string.IsNullOrEmpty(item.IconUrl))
                                                {
                                                    <img src="@item.IconUrl" alt="@item.Name"
                                                         style="width: 48px; height: 48px; border-radius: 4px; border: 2px solid #28a745;" />
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success p-2">
                                                        @item.Name (@item.TotalGold g)
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Sección de Hechizos de Invocador *@
        @if (matchup.SummonerSpell1Id.HasValue || matchup.SummonerSpell2Id.HasValue)
        {
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">Hechizos de Invocador Recomendados</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-4 align-items-center">
                                @if (matchup.SummonerSpell1Id.HasValue && summonerSpell1 != null)
                                {
                                    <div class="text-center">
                                        @if (!string.IsNullOrEmpty(summonerSpell1.ImageUrl))
                                        {
                                            <img src="@summonerSpell1.ImageUrl" alt="@summonerSpell1.Name"
                                                 style="width: 64px; height: 64px; border-radius: 8px; border: 3px solid #0d6efd;"
                                                 title="@summonerSpell1.Description" />
                                        }
                                        <p class="mb-0 mt-2 fw-bold">@summonerSpell1.Name</p>
                                        <small class="text-muted">@summonerSpell1.Cooldown s CD</small>
                                    </div>
                                }
                                @if (matchup.SummonerSpell2Id.HasValue && summonerSpell2 != null)
                                {
                                    <div class="text-center">
                                        @if (!string.IsNullOrEmpty(summonerSpell2.ImageUrl))
                                        {
                                            <img src="@summonerSpell2.ImageUrl" alt="@summonerSpell2.Name"
                                                 style="width: 64px; height: 64px; border-radius: 8px; border: 3px solid #0d6efd;"
                                                 title="@summonerSpell2.Description" />
                                        }
                                        <p class="mb-0 mt-2 fw-bold">@summonerSpell2.Name</p>
                                        <small class="text-muted">@summonerSpell2.Cooldown s CD</small>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Sección de Orden de Habilidades *@
        @if (!string.IsNullOrEmpty(matchup.AbilityOrder))
        {
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h4 class="mb-0">Orden de Habilidades (Niveles 1-18)</h4>
                        </div>
                        <div class="card-body p-0">
                            <AbilityOrderTable Champion="@matchup.PlayerChampion" AbilityOrder="@matchup.AbilityOrder" />
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Sección de Estrategia *@
        @if (!string.IsNullOrEmpty(matchup.Strategy))
        {
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0">Estrategia</h4>
                        </div>
                        <div class="card-body">
                            <pre style="white-space: pre-wrap; font-family: inherit;">@matchup.Strategy</pre>
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Tips y Consejos</h4>
                        <button class="btn btn-sm btn-success" @onclick="NavigateToAddTip">
                            Agregar Tip
                        </button>
                    </div>
                    <div class="card-body">
                        @if (matchup.Tips.Count == 0)
                        {
                            <div class="alert alert-warning" role="alert">
                                No hay tips para este matchup todavía.
                                <a href="/add-tip/@matchup.Id" class="alert-link">Sé el primero en agregar uno</a>
                            </div>
                        }
                        else
                        {
                            <div class="accordion" id="tipsAccordion">
                                @foreach (var category in GetGroupedTips())
                                {
                                    var categoryId = $"category-{category.Key.Replace(" ", "")}";
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="@($"heading-{categoryId}")">
                                            <button class="accordion-button" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="@($"#collapse-{categoryId}")"
                                                    aria-expanded="true"
                                                    aria-controls="@($"collapse-{categoryId}")">
                                                <strong>@category.Key</strong>
                                                <span class="badge bg-primary ms-2">@category.Value.Count tips</span>
                                            </button>
                                        </h2>
                                        <div id="@($"collapse-{categoryId}")"
                                             class="accordion-collapse collapse show"
                                             aria-labelledby="@($"heading-{categoryId}")"
                                             data-bs-parent="#tipsAccordion">
                                            <div class="accordion-body">
                                                @foreach (var tip in category.Value.OrderByDescending(t => t.Priority))
                                                {
                                                    <div class="card mb-2">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-start">
                                                                <div class="flex-grow-1">
                                                                    <p class="mb-2">@tip.Content</p>
                                                                    @if (!string.IsNullOrEmpty(tip.AuthorName))
                                                                    {
                                                                        <small class="text-muted">
                                                                            Por: @tip.AuthorName
                                                                        </small>
                                                                    }
                                                                </div>
                                                                <span class="badge bg-secondary">
                                                                    Prioridad: @tip.Priority
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-lg-12 text-center">
                <small class="text-muted">
                    Creado: @matchup.CreatedAt.ToString("dd/MM/yyyy HH:mm") |
                    Última actualización: @matchup.UpdatedAt.ToString("dd/MM/yyyy HH:mm")
                </small>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private MatchupDto? matchup;
    private bool isLoading = true;
    private string? errorMessage;
    private bool canEdit = false;
    private bool canDelete = false;
    private bool showDeleteModal = false;
    private bool isDeleting = false;

    // Runes data
    private List<RuneTreeDto> runeTrees = new();
    private RuneTreeDto? primaryTree;
    private RuneTreeDto? secondaryTree;
    private RuneDto? keystoneRune;
    private RuneDto? primaryRune1;
    private RuneDto? primaryRune2;
    private RuneDto? primaryRune3;
    private RuneDto? secondaryRune1;
    private RuneDto? secondaryRune2;

    // Items data
    private List<ItemDto> startingItems = new();
    private List<ItemDto> coreItems = new();
    private List<ItemDto> situationalItems = new();
    private List<ItemDto> fullBuildItems = new();

    // Summoner Spells data
    private SummonerSpellDto? summonerSpell1;
    private SummonerSpellDto? summonerSpell2;

    protected override async Task OnInitializedAsync()
    {
        await LoadMatchup();
    }

    private async Task LoadMatchup()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            matchup = await MatchupService.GetMatchupByIdAsync(Id);

            if (matchup != null)
            {
                await LoadRunesData();
                await LoadItemsData();
                await LoadSummonerSpellsData();
                await CheckUserPermissions();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"No se pudo cargar el matchup: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CheckUserPermissions()
    {
        if (matchup == null)
        {
            return;
        }

        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                canEdit = false;
                canDelete = false;
                return;
            }

            // El usuario puede editar/eliminar si es el creador o es administrador
            var isCreator = !string.IsNullOrEmpty(matchup.CreatedById) && matchup.CreatedById == currentUser.Id;
            var isAdmin = currentUser.Roles?.Contains("Admin") ?? false;
            var isGuest = currentUser.IsGuest;

            // Los administradores pueden editar/eliminar cualquier matchup (incluso los antiguos sin createdById)
            // Los usuarios normales solo pueden editar/eliminar sus propios matchups
            canEdit = !isGuest && (isCreator || isAdmin);
            canDelete = !isGuest && (isCreator || isAdmin);
        }
        catch (Exception)
        {
            canEdit = false;
            canDelete = false;
        }
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteModal = true;
    }

    private void CloseDeleteConfirmation()
    {
        showDeleteModal = false;
    }

    private async Task ConfirmDelete()
    {
        if (matchup == null) return;

        isDeleting = true;
        try
        {
            var success = await MatchupService.DeleteMatchupAsync(matchup.Id);

            if (success)
            {
                Console.WriteLine("Matchup deleted successfully, navigating back...");
                Navigation.NavigateTo("/matchups");
            }
            else
            {
                errorMessage = "No se pudo eliminar el matchup. Es posible que no tengas permisos.";
                showDeleteModal = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al eliminar el matchup: {ex.Message}";
            showDeleteModal = false;
        }
        finally
        {
            isDeleting = false;
        }
    }

    private async Task LoadRunesData()
    {
        if (matchup == null) return;

        try
        {
            runeTrees = await RuneService.GetRuneTreesAsync();
            var allRunes = await RuneService.GetAllRunesAsync();

            if (matchup.PrimaryTreeId.HasValue)
            {
                primaryTree = runeTrees.FirstOrDefault(t => t.TreeId == matchup.PrimaryTreeId);
            }

            if (matchup.SecondaryTreeId.HasValue)
            {
                secondaryTree = runeTrees.FirstOrDefault(t => t.TreeId == matchup.SecondaryTreeId);
            }

            if (matchup.KeystoneId.HasValue)
            {
                keystoneRune = allRunes.FirstOrDefault(r => r.RiotRuneId == matchup.KeystoneId);
            }

            if (matchup.PrimaryRune1Id.HasValue)
            {
                primaryRune1 = allRunes.FirstOrDefault(r => r.RiotRuneId == matchup.PrimaryRune1Id);
            }

            if (matchup.PrimaryRune2Id.HasValue)
            {
                primaryRune2 = allRunes.FirstOrDefault(r => r.RiotRuneId == matchup.PrimaryRune2Id);
            }

            if (matchup.PrimaryRune3Id.HasValue)
            {
                primaryRune3 = allRunes.FirstOrDefault(r => r.RiotRuneId == matchup.PrimaryRune3Id);
            }

            if (matchup.SecondaryRune1Id.HasValue)
            {
                secondaryRune1 = allRunes.FirstOrDefault(r => r.RiotRuneId == matchup.SecondaryRune1Id);
            }

            if (matchup.SecondaryRune2Id.HasValue)
            {
                secondaryRune2 = allRunes.FirstOrDefault(r => r.RiotRuneId == matchup.SecondaryRune2Id);
            }
        }
        catch
        {
            // Silently fail - runes are optional display
        }
    }

    private async Task LoadItemsData()
    {
        if (matchup == null) return;

        try
        {
            if (!string.IsNullOrEmpty(matchup.StartingItems))
            {
                startingItems = await ItemService.GetItemsByRiotIdsAsync(matchup.StartingItems);
            }

            if (!string.IsNullOrEmpty(matchup.CoreItems))
            {
                coreItems = await ItemService.GetItemsByRiotIdsAsync(matchup.CoreItems);
            }

            if (!string.IsNullOrEmpty(matchup.SituationalItems))
            {
                situationalItems = await ItemService.GetItemsByRiotIdsAsync(matchup.SituationalItems);
            }

            if (!string.IsNullOrEmpty(matchup.FullBuildItems))
            {
                fullBuildItems = await ItemService.GetItemsByRiotIdsAsync(matchup.FullBuildItems);
            }
        }
        catch
        {
            // Silently fail - items are optional display
        }
    }

    private async Task LoadSummonerSpellsData()
    {
        if (matchup == null) return;

        try
        {
            if (matchup.SummonerSpell1Id.HasValue)
            {
                summonerSpell1 = await SummonerSpellService.GetSummonerSpellByIdAsync(matchup.SummonerSpell1Id.Value);
            }

            if (matchup.SummonerSpell2Id.HasValue)
            {
                summonerSpell2 = await SummonerSpellService.GetSummonerSpellByIdAsync(matchup.SummonerSpell2Id.Value);
            }
        }
        catch
        {
            // Silently fail - summoner spells are optional display
        }
    }

    private Dictionary<string, List<MatchupTipDto>> GetGroupedTips()
    {
        if (matchup == null || matchup.Tips.Count == 0)
            return new Dictionary<string, List<MatchupTipDto>>();

        return matchup.Tips
            .GroupBy(t => t.Category)
            .ToDictionary(g => GetCategoryDisplayName(g.Key), g => g.ToList());
    }

    private string GetCategoryDisplayName(string category)
    {
        return category switch
        {
            "EarlyGame" => "Early Game",
            "MidGame" => "Mid Game",
            "LateGame" => "Late Game",
            "Items" => "Items",
            "Runes" => "Runas",
            "Abilities" => "Habilidades",
            "General" => "General",
            _ => category
        };
    }

    private string GetDifficultyBadgeClass(string difficulty)
    {
        return difficulty switch
        {
            "Easy" => "bg-success",
            "Medium" => "bg-warning",
            "Hard" => "bg-danger",
            "Extreme" => "bg-dark",
            _ => "bg-secondary"
        };
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/matchups");
    }

    private void NavigateToAddTip()
    {
        Navigation.NavigateTo($"/add-tip/{Id}");
    }

    private void NavigateToEdit()
    {
        Navigation.NavigateTo($"/edit-matchup/{Id}");
    }
}
